<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPI使用经验笔记 &mdash; Goodix BLE Start Guide v1.0 文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5a3fd9cb"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/translations.js?v=beaddf03"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="DMA" href="../DMA/index.html" />
    <link rel="prev" title="QSPI使用经验笔记" href="AN01_QSPI%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C%E7%AC%94%E8%AE%B0.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Goodix BLE Start Guide
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">Menu List</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../%E5%BC%80%E5%8F%91%E5%90%91%E5%AF%BC/index.html">开发向导</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88/index.html">技术方案</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">应用笔记</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">SPI与QSPI</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01_SPI-QSPI%E5%8D%8F%E8%AE%AE%E4%B8%93%E9%A2%98%281%29%20-%20%E5%9F%BA%E7%A1%80%E5%8D%8F%E8%AE%AE%E7%89%B9%E5%BE%81%E4%BB%8B%E7%BB%8D.html">01.SPI-QSPI协议专题(1) - 基础协议特征介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="02_SPI-QSPI%E5%8D%8F%E8%AE%AE%E4%B8%93%E9%A2%98%282%29%20-%20%E6%9E%84%E5%BB%BAGR55xx%20%28Q%29SPI%E9%AB%98%E9%80%9F%E4%BC%A0%E8%BE%93%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%9F%BA%E7%A1%80.html">02.SPI-QSPI协议专题(2) - 构建GR55xx (Q)SPI高速传输接口的基础</a></li>
<li class="toctree-l3"><a class="reference internal" href="03_SPI-QSPI%E5%8D%8F%E8%AE%AE%E4%B8%93%E9%A2%98%283%29%20-%20GR552x%E8%8A%AF%E7%89%87DMA%E5%8F%8AQSPI%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E7%89%B9%E5%BE%81.html">03.SPI-QSPI协议专题(3) - GR552x芯片DMA及QSPI模块功能特征</a></li>
<li class="toctree-l3"><a class="reference internal" href="04_SPI-QSPI%E5%8D%8F%E8%AE%AE%E4%B8%93%E9%A2%98%284%29%20-%20%E8%89%B2%E5%BD%A9%E6%A0%BC%E5%BC%8F%E5%8F%8A%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8.html">04.SPI-QSPI协议专题(4) - 色彩格式及常见异常</a></li>
<li class="toctree-l3"><a class="reference internal" href="AN01_QSPI%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C%E7%AC%94%E8%AE%B0.html">QSPI使用经验笔记</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">SPI使用经验笔记</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">1. 基本功能介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">2. 应用笔记</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spi-faq">3. SPI-FAQ</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../DMA/index.html">DMA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BLE/index.html">BLE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/index.html">常见问题</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Goodix BLE Start Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">应用笔记</a></li>
          <li class="breadcrumb-item"><a href="index.html">SPI与QSPI</a></li>
      <li class="breadcrumb-item active">SPI使用经验笔记</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/应用笔记/SPI与QSPI/AN02_SPI使用经验笔记.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="spi">
<h1>SPI使用经验笔记<a class="headerlink" href="#spi" title="Link to this heading"></a></h1>
<p>[TOC]</p>
<section id="id1">
<h2>1. 基本功能介绍<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>各芯片的SPI 模块数量及主要参数</p></li>
</ul>
<table border="1" class="docutils">
<thead>
<tr>
<th>SoC</th>
<th>SPI实例</th>
<th>主要参数</th>
</tr>
</thead>
<tbody>
<tr>
<td>GR551x</td>
<td>SPIM、SPIS</td>
<td>SPIM最高主频32MHz; FIFO深度8x4字节</td>
</tr>
<tr>
<td>GR5525</td>
<td>SPIM、SPIS</td>
<td>SPIM最高主频48MHz;  FIFO深度16x4字节</td>
</tr>
<tr>
<td>GR5526</td>
<td>SPIM、SPIS</td>
<td>SPIM最高主频48MHz; FIFO深度16x4字节</td>
</tr>
<tr>
<td>GR533x</td>
<td>SPIM、SPIS</td>
<td>SPIM最高主频32MHz; FIFO深度8x4字节</td>
</tr>
</tbody>
</table></section>
<section id="id2">
<h2>2. 应用笔记<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>使用SPI Master 模块建议均采用软件片选模式</p></li>
<li><p>当应用场景只需要SPI 提供 MOSI 信号时, 也可以考虑使用QSPI 模块的SPI模式代替</p></li>
<li><p>SPI Master使用注意事项:</p>
<ul>
<li><p>当接收数据时,如果数据量较大或SPI工作频率较高, 如果CPU或DMA取数据速度跟不上 SPI FIFO读入速度, 会发生接收溢出现象, 导致数据丢失。优化方法:</p>
<ul>
<li><p>优先采用 DMA 进行传输, DMA的传输带宽远大于CPU, 可以有效降低 接收溢出现象</p></li>
<li><p>当采用 DMA 接收数据时, 如果还有溢出现象, 如果应用场景运行, 可以 配置4字节传输宽度, 进一步提高 SPI FIFO的利用率, 改善传输带宽</p></li>
<li><p>如果对宽度要求不高的场景, 还可以减少单次数据接收量来降低接收溢出概率</p></li>
<li><p>如果进行上述优化后依然存在 接收溢出现象, 请在软件层设计重读逻辑, 当数据溢出发生时, 丢弃上次读取数据, 重新读取一次.</p></li>
</ul>
</li>
<li><p>如果使用的硬件控制CS片选信号, 当发送数据时, 如果数据量较大或SPI工作频率较高, CPU或DMA发送速度跟不上 SPI FIFO 的发送速度, 会出行 CS 信号自动拉起的行为, 导致后面的时序数据紊乱.</p>
<ul>
<li><p>优化方法为使用软件方法控制片选信号的拉低和拉高.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>SPI 是强时序协议, 当SPI通讯存在异常时, 可尝试使用逻辑分析器抓取 SPI信号, 分析问题的可能性.</p></li>
<li><p>SPI 驱动提供了三种模式的访问接口: 轮询模式、中断模式、DMA模式．各模式的经验性建议如下，按照建议，会很好的降低接收溢出发生的概率，但概率依然存在．</p>
<ul>
<li><p>GR551x 和 GR533x:</p>
<ul>
<li><p>轮询模式和中断模式使用条件:</p>
<ul>
<li><p>建议单次传输数据量小于 4拍</p></li>
<li><p>建议在 SPI 工作频率不大于1MHz 情况下使用</p></li>
<li><p>使用场景适用于低频率和小数据量</p></li>
</ul>
</li>
<li><p>DMA模式使用条件</p>
<ul>
<li><p>单次传输小于 4095 拍的任意数据量</p></li>
<li><p>SPI工作频率小于等于 32MHz 下</p></li>
<li><p>如果发生接收溢出, 减少单次数据传输量和应用层增加重读机制</p></li>
</ul>
</li>
</ul>
</li>
<li><p>GR5525和GR5526:</p>
<ul>
<li><p>轮询模式和中断模式使用条件:</p>
<ul>
<li><p>建议单次传输数据量小于 8拍</p></li>
<li><p>建议在 SPI 工作频率不大于8MHz 情况下使用</p></li>
<li><p>使用场景适用于低频率和小数据量</p></li>
</ul>
</li>
<li><p>DMA模式使用条件</p>
<ul>
<li><p>单次传输小于 4095 拍的任意数据量, 但可通过 LLP 扩展传输数据上限</p></li>
<li><p>SPI工作频率小于等于 48MHz 下</p></li>
<li><p>如果发生接收溢出, 减少单次数据传输量和应用层增加重读机制</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="spi-faq">
<h2>3. SPI-FAQ<a class="headerlink" href="#spi-faq" title="Link to this heading"></a></h2>
<section id="id3">
<h3>3.1 SPI支持的最大频率是多少?<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>SPI 模块分为SPI Master和SPI Slave, 其中SPI Master支持的最大频率是系统最高频率的二分之一, SPI Master支持的分频系数为 2 ~ 65535 之间的偶数, 不支持奇数分频.</p></li>
<li><p>各款芯片SPI Master模块的最大频率支持如下:</p>
<ul>
<li><p>GR551x 全系列芯片最高主频为64MHz, SPI Master的最大工作频率为 32MHz, 时钟源为系统时钟</p></li>
<li><p>GR5525 全系列芯片最高主频为96MHz, SPI Master的最大工作频率为 48MHz, 时钟源为外设时钟</p></li>
<li><p>GR5526 全系列芯片最高主频为96MHz, SPI Master的最大工作频率为 48MHz , 时钟源为外设时钟</p></li>
<li><p>GR533x 全系列芯片最高主频为64MHz, SPI Master的最大工作频率为 32MHz, 时钟源为外设时钟</p></li>
</ul>
</li>
</ul>
</section>
<section id="id4">
<h3>3.2 什么是软件片选, 什么是硬件片选, 使用有什么区别?<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>软件片选: 在进行SPI 传输前, 由软件拉低控制CS引脚所在的IO；SPI传输完成后, 由软件拉高控制CS引脚所在的IO. CS的行为由软件代码控制。这个时候的CS引脚IO需要配置为 Output 模式</p></li>
<li><p>硬件片选: SPI的片选信号的拉低和拉高, 全部由芯片的SPI 模块负责, 这个时候CS引脚所在IO需要配置为 CS 功能的 mux模式</p></li>
<li><p>为什么会存在软件片选?</p>
<ul>
<li><p>SPI在发送数据的时候, 有可能因为数据量大、传输速率高或CPU来不及处理等原因, 发送时候向 SPI FIFO喂数据的速度跟不上导致FIFO 变空, 如果这个时候是使用硬件片选, 就会将CS 进行自动拉高释放, 而产生错误的访问时序.</p></li>
</ul>
</li>
<li><p>什么时候需要使用软件片选?</p>
<ul>
<li><p>当传输数据量比较大、SPI频率配置比较高时, 就建议使用软件片选, 由于数据量大小和频率高低是一个相对概念, 无法精确的基于场景进行计算. 因此建议, 所有使用 SPI 传输的场景, 都启用软件片选. 这个建议适用于 GR551x、GR5525、GR5526、GR533x 所有系列芯片.</p></li>
<li><p>SPI 在 app驱动层, 预置了 软件片选支持, 使用的时候注意开启相关控制宏即可. 详情可参考  app_spi.c 文件驱动代码</p></li>
</ul>
</li>
</ul>
</section>
<section id="spi-app-spi-evt-error">
<h3>3.3 SPI 接收数据时发生了回调错误事件 APP_SPI_EVT_ERROR, 怎么处理?<a class="headerlink" href="#spi-app-spi-evt-error" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>如果SPI在接收数据的时候, 有可能因为数据量大、传输速率高或CPU来不及处理等原因, 导致 SPI 模块的接收FIFO 被Slave 过来的数据塞满, 发生 FIFO 接收溢出错误 (Receive Overflow Error). 当这个错误发生时, 会通过回调事件 APP_SPI_EVT_ERROR告知用户. 正确的处理方法是, 调用接口重新收一遍数据. 另外, 这种情况, 请使用 DMA 传输模式降低概率</p></li>
<li><p>如果原因不是上面描述, 同时使用的DMA传输方式的话, 则可能是 DMA 的传输数据量过大. 需要限制DMA单次传输在4095拍以内.</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="AN01_QSPI%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C%E7%AC%94%E8%AE%B0.html" class="btn btn-neutral float-left" title="QSPI使用经验笔记" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../DMA/index.html" class="btn btn-neutral float-right" title="DMA" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2023, Goodix。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>