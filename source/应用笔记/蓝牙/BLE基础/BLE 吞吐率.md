## BLE 数据传输速率



### 1. 理论传输速率

* BLE在物理层支持2M PHY，1MPHY和Coded PHY 
* BLE数据传输已知信息：
  * GFSK调制方式，2MPHY每一个bit占用时间为0.5μs，1MPHY 占用1us
  * 数据包的时间间距(T_IFS)为固定的150μs.
  * 传输时隙格式为TX数据包 + 数据包间距+RX空包 + 数据包间距 
  * ATT层数据传输格式为：前导码（1M为1字节，2M为2字节）+ 存取地址（4字节）+ Header（2字节）+Payload（251字节）+ CRC（3字节） 
  * 对于在GATT之上工作的应用程序，I2CAP和ATT都有自己的开销，通常，GATT的最大有效载荷为(251 - 7 =)244字节
* 使用2MPHY，理论传输速率计算如下：
  * TX数据包总长度 = 2096bits, 占用时间为1048μs.
  * RX空包总长度 =  88 bits, 占用时间为44μs.
  * 一次传输总时间为 1048+44+（150*2） = 1392us
  * **可计算出LE 2M PHY模式下应用层最大数据传输速率 = (244* 8) / 1392µs ≈  1402kbps.**
* 使用1MPHY，理论传输速率计算如下：
  * TX数据包总长度 = 2120 bits, 占用时间为2088μs.
  * RX空包总长度 =  80 bits, 占用时间为80μs.
  * 一次传输总时间为 2120+80+（150*2） = 2500us
  * **可计算出LE 1M PHY模式下应用层最大数据传输速率 = (244* 8) / 2500us ≈  780kbps.**



### 2. BLE数据传输速率影响因素

*  BLE传输速率的因素比较多，主要有PDU、CI、MTU、CE和PHY参数，还跟RF性能、环境、Master和Slave之间的距离，通信模式有关。
* Slave和Master常用的通信模式有Indicate、Notify、Write Without Response、Write With Response。对于Indicate、Write With Response都需要对端应答的模式，一个Interval只会发送一包数据。
* BLE Connection相关配置参数主要影响通信实时性、吞吐率、功耗、抗干扰性、断链响应实时性等，对于吞吐率，主要跟两个要素有关，通信周期CI和每个通信点可传输的数据量（MTU和PDU）。
* 对于CI并不是越小，数据吞吐率就越高，当CI越小，整个时间段预留硬件准备时间占比越大，实际通信数据时间越短，这样看来CI需要配置比较大。但当CI越大，一旦出现数据错误，浪费CI中剩余时间越多，这样看来CI需要配置比较小，可快速继续下一次通信。因此并不是CI越小，吞吐率越高，或者CI越大，吞吐率越高
* **所以在高数据吞吐率场景，一般会采用典型经验值，CI为30~45ms，PHY为2M，PDU为251，MTU为247**
* 如果需要对BLE 数据传输速率进行测试，可以使用SDK目录projects\ble\ble_peripheral\ble_app_throughput的示例工程，配合GRToolbox工具进行测试



### 3. FAQ

1. 在手机端想修改PDU参数，但没有找到API接口，怎么实现？

   > * 手机端发起参数更新，能得到确定的值的就是 mtu 了，如果要在连接后，精确的修改连接参数，一般情况下，是让手机发命令给到Slave芯片端，芯片端来发起参数更新，具体的实现的可以参考我们SDK里Throughput工程。
   > * 手机在进行MTU设置时，会进行一次PDU Update，将手机端的PDU Max值进行更新，如果要单独发指令让设备端进行PDU设置，要先将MTU进行更新，不然手机端一直默认是27最大PDU Length，设备端发起比27大的值更新，会失败。

2. 吞吐率测试时，苹果手机吞吐率偏低，是什么原因？

   > IOS的连接间隔CI默认为30ms，不同的系统，CI更新，可以接受的值不一样，最小在20ms，但不能像Android 一样，CI可以更新到最小值7.5ms；苹果MTU不同IOS版本也是不一样，在185 Bytes左右，所以IOS BLE传输速率，不能像Android 一样，达到最优值。